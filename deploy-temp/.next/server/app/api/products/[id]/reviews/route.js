(()=>{var e={};e.id=615,e.ids=[615,558],e.modules={62849:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=62849,e.exports=r},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},524:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{"use strict";e.exports=require("buffer")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},98216:e=>{"use strict";e.exports=require("net")},35816:e=>{"use strict";e.exports=require("process")},76162:e=>{"use strict";e.exports=require("stream")},74026:e=>{"use strict";e.exports=require("string_decoder")},95346:e=>{"use strict";e.exports=require("timers")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},58515:(e,r,t)=>{"use strict";t.r(r),t.d(r,{originalPathname:()=>x,patchFetch:()=>h,requestAsyncStorage:()=>v,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>_});var s={};t.r(s),t.d(s,{GET:()=>d,POST:()=>p});var i=t(49303),o=t(88716),u=t(60670),n=t(87070),a=t(75748),c=t(95456);async function d(e,{params:r}){try{let e=(0,a.M)(),t=parseInt(r.id),[s]=await e.execute(`SELECT 
        r.*,
        u.first_name,
        u.last_name,
        u.email
      FROM product_reviews r
      JOIN users u ON r.user_id = u.id
      WHERE r.product_id = ? AND r.is_approved = 1
      ORDER BY r.created_at DESC`,[t]),i=s.map(e=>({id:e.id,productId:e.product_id,userId:e.user_id,rating:e.rating,title:e.title,comment:e.comment,isVerifiedPurchase:1===e.is_verified_purchase,helpfulCount:e.helpful_count,author:{name:`${e.first_name||""} ${e.last_name||""}`.trim()||"Anonymous",email:e.email},createdAt:e.created_at}));return n.NextResponse.json({reviews:i})}catch(e){return console.error("Error fetching reviews:",e),n.NextResponse.json({error:"Failed to fetch reviews",message:e.message},{status:500})}}async function p(e,{params:r}){try{let t=(0,a.M)(),s=parseInt(r.id),i=e.headers.get("authorization");if(!i||!i.startsWith("Bearer "))return n.NextResponse.json({error:"Unauthorized"},{status:401});let o=i.substring(7),u=(0,c.verifyToken)(o);if(!u||"customer"!==u.role)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{rating:d,title:p,comment:l}=await e.json();if(!d||d<1||d>5)return n.NextResponse.json({error:"Rating must be between 1 and 5"},{status:400});let[v]=await t.execute("SELECT id FROM product_reviews WHERE user_id = ? AND product_id = ?",[u.id,s]);if(v&&v.length>0)return n.NextResponse.json({error:"You have already reviewed this product"},{status:409});let[_]=await t.execute(`SELECT COUNT(*) as count
       FROM orders o
       JOIN order_items oi ON o.id = oi.order_id
       WHERE o.user_id = ? AND oi.product_id = ? AND o.status = 'delivered'`,[u.id,s]),m=_[0]?.count>0,[x]=await t.execute(`INSERT INTO product_reviews (product_id, user_id, rating, title, comment, is_verified_purchase)
       VALUES (?, ?, ?, ?, ?, ?)`,[s,u.id,d,p||null,l||null,m?1:0]),[h]=await t.execute(`SELECT AVG(rating) as avg_rating, COUNT(*) as review_count
       FROM product_reviews
       WHERE product_id = ? AND is_approved = 1`,[s]);return h&&h.length>0&&await t.execute("UPDATE products SET rating = ?, review_count = ? WHERE id = ?",[parseFloat(h[0].avg_rating||0),h[0].review_count||0,s]),n.NextResponse.json({success:!0,reviewId:x.insertId},{status:201})}catch(e){return console.error("Error creating review:",e),n.NextResponse.json({error:"Failed to create review",message:e.message},{status:500})}}let l=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/products/[id]/reviews/route",pathname:"/api/products/[id]/reviews",filename:"route",bundlePath:"app/api/products/[id]/reviews/route"},resolvedPagePath:"E:\\amertrading.shop\\src\\app\\api\\products\\[id]\\reviews\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:v,staticGenerationAsyncStorage:_,serverHooks:m}=l,x="/api/products/[id]/reviews/route";function h(){return(0,u.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:_})}},95456:(e,r,t)=>{"use strict";t.d(r,{Oe:()=>a,RA:()=>c,c_:()=>n,verifyToken:()=>d});var s=t(98691),i=t(41482),o=t.n(i);let u=process.env.JWT_SECRET||"your-secret-key-change-in-production";function n(e){return s.ZP.hashSync(e,10)}function a(e,r){return s.ZP.compareSync(e,r)}function c(e){return o().sign(e,u,{expiresIn:"7d"})}function d(e){try{return o().verify(e,u)}catch{return null}}},75748:(e,r,t)=>{"use strict";t.d(r,{M:()=>o});var s=t(73785);let i=null;function o(){return i||(i=s.createPool({host:process.env.DB_HOST||"localhost",user:process.env.DB_USER||"root",password:process.env.DB_PASSWORD||"",database:process.env.DB_NAME||"amer_shop",waitForConnections:!0,connectionLimit:10,queueLimit:0})),i}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[276,972,785,86],()=>t(58515));module.exports=s})();