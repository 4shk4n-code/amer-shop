// Fix Prisma 7 client structure - create default.js that @prisma/client expects
const fs = require('fs');
const path = require('path');

const prismaClientPath = path.join(__dirname, '../node_modules/.prisma/client');
const defaultJsPath = path.join(prismaClientPath, 'default.js');

// Check if .prisma/client directory exists
if (!fs.existsSync(prismaClientPath)) {
  console.log('‚ö†Ô∏è  Prisma Client directory not found at', prismaClientPath);
  console.log('   This is normal if Prisma hasn\'t generated yet. Skipping fix.');
  process.exit(0); // Don't fail, just skip
}

// List files to see what Prisma generated
const files = fs.readdirSync(prismaClientPath);
console.log('üìÅ Files in node_modules/.prisma/client:', files.join(', '));

// Create default.js that properly exports PrismaClient
// Since Prisma 7 generates TypeScript, we need to handle this carefully
// At runtime, Next.js will have compiled the TypeScript, so we can require it
const defaultContent = `// This file is auto-generated by fix-prisma.js
// Prisma 7 generates TypeScript files, but @prisma/client expects this JS file

// At build time, this will fail, but that's okay - Next.js will handle it
// At runtime, the TypeScript will be compiled and this will work
try {
  // Try to require the compiled client (works at runtime after Next.js compilation)
  const clientModule = require('./client');
  const PrismaClient = clientModule.PrismaClient || clientModule.default?.PrismaClient;
  
  if (PrismaClient) {
    module.exports = { PrismaClient };
    module.exports.PrismaClient = PrismaClient;
  } else {
    throw new Error('PrismaClient not found in client module');
  }
} catch (e) {
  // At build time, create a proxy that will be replaced at runtime
  // This allows the build to continue
  const PrismaClientProxy = class {
    constructor(options) {
      // This will be replaced at runtime with the actual PrismaClient
      throw new Error('PrismaClient must be imported from @prisma/client, not from .prisma/client/default');
    }
  };
  
  module.exports = { PrismaClient: PrismaClientProxy };
  module.exports.PrismaClient = PrismaClientProxy;
}
`;

fs.writeFileSync(defaultJsPath, defaultContent);
console.log('‚úÖ Created node_modules/.prisma/client/default.js');
