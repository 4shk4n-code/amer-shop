// Fix Prisma 7 client structure - create default.js that @prisma/client expects
const fs = require('fs');
const path = require('path');

const prismaClientPath = path.join(__dirname, '../.prisma/client');
const defaultJsPath = path.join(prismaClientPath, 'default.js');
const indexJsPath = path.join(prismaClientPath, 'index.js');

// Check if .prisma/client directory exists
if (!fs.existsSync(prismaClientPath)) {
  console.log('⚠️  Prisma Client directory not found at', prismaClientPath);
  console.log('   This is normal if Prisma hasn\'t generated yet. Skipping fix.');
  process.exit(0); // Don't fail, just skip
}

// Prisma 7 generates TypeScript files, but we need a JavaScript entry point
// Create index.js that exports from the generated client
const clientTsPath = path.join(prismaClientPath, 'client.ts');
if (fs.existsSync(clientTsPath)) {
  // Create index.js that properly exports PrismaClient
  const indexContent = `// This file is auto-generated by fix-prisma.js
// Prisma 7 generates TypeScript files, so we need to use dynamic import
// For Node.js, we'll use a workaround to load the compiled client

// Try to load from the compiled output or use require with ts-node/register
try {
  // First, try to require the client directly (if compiled)
  const client = require('./client');
  module.exports = client;
} catch (e) {
  // If that fails, try to load from a compiled version
  // This is a fallback for when TypeScript files aren't compiled
  const { PrismaClient } = require('@prisma/client/runtime/library');
  module.exports = { PrismaClient };
}
`;
  
  // Create default.js that exports from index.js
  const defaultContent = `// This file is auto-generated by fix-prisma.js
// Re-export from index.js
module.exports = require('./index.js');
`;

  fs.writeFileSync(indexJsPath, indexContent);
  fs.writeFileSync(defaultJsPath, defaultContent);
  console.log('✅ Created .prisma/client/index.js and default.js');
} else {
  // Fallback: create a simple default.js that tries to load from @prisma/client
  const defaultContent = `// This file is auto-generated by fix-prisma.js
// Fallback: try to load PrismaClient from the runtime
const { PrismaClient } = require('@prisma/client/runtime/library');
module.exports = { PrismaClient };
`;
  fs.writeFileSync(defaultJsPath, defaultContent);
  console.log('✅ Created .prisma/client/default.js (fallback)');
}

