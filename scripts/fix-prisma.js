// Fix Prisma 7 client structure - create default.js that @prisma/client expects
const fs = require('fs');
const path = require('path');

const prismaClientPath = path.join(__dirname, '../node_modules/.prisma/client');
const defaultJsPath = path.join(prismaClientPath, 'default.js');

// Check if .prisma/client directory exists
if (!fs.existsSync(prismaClientPath)) {
  console.log('‚ö†Ô∏è  Prisma Client directory not found at', prismaClientPath);
  console.log('   This is normal if Prisma hasn\'t generated yet. Skipping fix.');
  process.exit(0); // Don't fail, just skip
}

// List files to see what Prisma generated
const files = fs.readdirSync(prismaClientPath);
console.log('üìÅ Files in node_modules/.prisma/client:', files.join(', '));

// Prisma 7 generates TypeScript files, but @prisma/client expects default.js
// Create default.js that properly exports PrismaClient
// The generated client.ts will be compiled by Next.js, so we need to handle both cases

// Create index.js first that properly exports from client.ts
const indexJsPath = path.join(prismaClientPath, 'index.js');
const indexContent = `// This file is auto-generated by fix-prisma.js
// Re-export from the generated TypeScript client
// Next.js will compile this during build
export * from './client';
export { PrismaClient } from './client';
`;

// Create default.js that exports from index.js
const defaultContent = `// This file is auto-generated by fix-prisma.js
// Prisma 7 generates TypeScript files, but @prisma/client expects this JS file
// We export from index.js which will be compiled by Next.js

// Use dynamic import to handle TypeScript compilation
// At build time, Next.js will compile the TypeScript, so this will work
const path = require('path');
const fs = require('fs');

// Check if index.js exists (compiled by Next.js)
const indexJsPath = path.join(__dirname, 'index.js');
if (fs.existsSync(indexJsPath)) {
  // If index.js exists, use it
  module.exports = require('./index.js');
} else {
  // If not compiled yet, create a proxy that will work at runtime
  // The actual client will be loaded via the webpack alias or at runtime
  const { PrismaClient: PrismaClientBase } = require('@prisma/client/runtime/library');
  
  // Create PrismaClient class that extends the base
  class PrismaClient extends PrismaClientBase {
    constructor(options) {
      super({
        ...options,
        __dirname: __dirname,
      });
    }
  }
  
  module.exports = { PrismaClient };
  module.exports.PrismaClient = PrismaClient;
}
`;

fs.writeFileSync(indexJsPath, indexContent);
fs.writeFileSync(defaultJsPath, defaultContent);
console.log('‚úÖ Created node_modules/.prisma/client/index.js and default.js');

